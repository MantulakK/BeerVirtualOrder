<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Artículos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">

<style>
    body.dark-background {
        background-color: #333333 !important;
        color: #ffffff !important;
    }

    table.dark-table {
        background-color: #333333 !important;
    }

    table.dark-table td {
        color: #000000 !important;
    }
</style>


</head>
<body class="bg-dark text-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: white;">
                            Navegación
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="/orders">Pedidos</a></li>
                            <li><a class="dropdown-item" href="/tables">Mesas</a></li>
                            <li><a class="dropdown-item" href="/qrcodes">Códigos QR</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-3">
            <div class="col d-flex align-items-center">
                <h1 class="center"> Artículos </h1>
            </div>
            <div class="col-auto">
                <a class="navbar-brand" href="{{ url_for('index') }}">
                    <img src="../static/img/home.png" width="150">
                </a>
            </div>
        </div>
    </div>



<!--  ESTE BLOQUE SE USA PARA PODER MOSTRAR UN MENSAJE EN CASO DE QUE SE DETECTE UNA INSERCIÓN DE UN ARTICULO CON UN NOMBRE YA EXISTENTE O DE UNA INSERCIÓN EXITOSA    -->
    <div class="container">
        <div class="card">
            <div class="card-body">
                {% with messages = get_flashed_messages() %}
                  {% if messages %}
                    <div class="alert alert-info">
                      <ul>
                        {% for message in messages %}
                          <li>{{ message }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                {% endwith %}

                <div class="container">
                    <div class="card">
                        <div class="card-body">
                            <!-- Botón para abrir el modal -->
                            <button class="btn btn-success mb-3 mt-4" type="button" data-bs-toggle="modal" data-bs-target="#crearArticuloModal">Crear Artículo</button>
                        </div>
                    </div>
                </div>            

    <!-- MODAL DE CREACIÓN  -->
    <div class="modal fade" id="crearArticuloModal" tabindex="-1" aria-labelledby="crearArticuloModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crearArticuloModalLabel" onclick="openCrearArticuloModal()">Crear Artículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario dentro del modal -->
                    <form action="{{ url_for('articles.create_article') }}" method="POST">
                        <div class="row mb-3">
                            <strong><label>Nombre de Articulo</label></strong>
                            <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Insertar Nombre" name="name" id="name" required>
                            
                            <strong><label>Marca</label></strong>
                            <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Insertar Marca" name="brand" id="brand" required>                      
    
                            <strong><label>Descripción</label></strong>
                            <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Insertar Descripcion" name="description" id="description" required>
    
                            <strong><label>Tipo</label></strong>
                            <select name="article_type" id="article_type"  class="form-control mb-3">
                                <option value="1">Comida</option>
                                <option value="2">Bebida</option>
                            </select>
                            
                            <strong><label>Precio Unitario</label></strong>
                            <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Insertar Precio" name="single_price" id="single_price" required>
                        
                        </div>    
                        <div class="modal-footer">
                            <button class="btn btn-success" type="submit" onclick="confirm('CREAR ARTÍCULO?')">Confirmar</button>
                            <button class="btn btn-danger" type="button" onclick="clearFields(); alert('CREACION CANCELADA!');" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- TABLA -->
<table class="table table-bordered table-dark" id="articlesTable">
    <thead>
        <th scope="col">#</th>
        <th scope="col">Nombre</th>
        <th scope="col">Marca</th>
        <th scope="col">Descripción</th>
        <th scope="col">Tipo</th>
        <th scope="col">Precio</th>
        <th scope="col">Editar</th>
        <th scope="col">Imagen</th>


    </thead>
    <tbody class="dark-text bg-dark"> <!-- A ESTE ELEMENTO SE LE AGREGAN LOS DATOS DE LA BASE DE DATOS -->
        {% for article in articles %}
        <tr>
          <td>{{ article['id_article'] }}</td>
          <td>{{ article['name'] }}</td>
          <td>{{ article['brand'] }}</td>
          <td>{{ article['description'] }}</td>
          
          
          <td>
            {% if article['article_type'] == 1 %}
                Comida
            {% elif article['article_type'] == 2 %}
                Bebida
            {% endif %}
          </td>
          <td>{{ article['single_price'] }}</td>
          <td><button class="btn btn-primary btn-sm" id="modal{{article.id_article}}" data-bs-toggle="modal" data-bs-target="#modal{{article.id_article}}">EDITAR</button></td>
          <td><button class="btn btn-primary btn-sm" id="modal{{article.id_article}}" data-bs-toggle="modal" data-bs-target="#selectImageModal" onclick="openSelectImageModal()">IMAGEN</button></td>
        </tr>

        <!-- MODAL DE EDICIÓN  -->
        <div class="modal fade" id="modal{{article.id_article}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">{{article.name}}</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('articles.edit_article', id_article=article['id_article']) }}" method="POST">
                        <strong><label>Nombre</label></strong>
                        <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Edit Name" name="name" value="{{article.name}}" required>
                        
                        <strong><label>Marca</label></strong>
                        <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Edit Brand" name="brand" value="{{article.brand}}" required>                      

                        <strong><label>Descripción</label></strong>
                        <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Edit Description" name="description" value="{{article.description}}" required>

                        <strong><label>Tipo</label></strong>
                        <select name="article_type" id="article_type"  class="form-control mb-3">
                            <option value="1">Comida</option>
                            <option value="2">Bebida</option>
                        </select>
                        
                        <strong><label>Precio Unitario</label></strong>
                        <input type="text" class="form-control mb-3" autocomplete="off" placeholder="Edit Price" name="single_price" value="{{article.single_price}}" required>

                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
              </div>
            </div>
          </div>

      {% endfor %}
    </tbody>
</table>
            </div>
        </div>
    </div>

<!-- MODAL DE SELECCIÓN DE IMAGEN -->
<div class="modal fade" id="selectImageModal" tabindex="-1" aria-labelledby="selectImageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectImageModalLabel" style="color: black;">Seleccionar Imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <input type="hidden" name="img_path" id="img_path">
            </div>
            <div class="modal-body">
                <form id="imageForm" enctype="multipart/form-data">
                    <input type="file" name="imageFile" id="imageFile" accept="image/*">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="uploadImage()">Subir Imagen</button>
            </div>
        </div>
    </div>
</div>
    
    
<!-- FUNCION PARA LIMPAR LOS CAMPOS DE CREACION  -->
    <script>
        function clearFields() {
            document.getElementById("name").value = "";
            document.getElementById("brand").value = "";
            document.getElementById("description").value = "";
            document.getElementById("single_price").value = "";
        }
    </script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Inicializar DataTables después de cargar jQuery y DataTables
    /*$(document).ready(function() {
        $('#articlesTable').DataTable();
        
    });*/

    $(document).ready(function() {
    $('#articlesTable').dataTable( {
  "language": {
    "search": "Buscar Registro:",
    "info": "Mostrando página _PAGE_ de _PAGES_",
    "lengthMenu": "Mostrando _MENU_ registros",
    "paginate": {
      "next": "Siguiente",
      "previous": "Anterior"
    }


  }
} );
});
    function openCrearArticuloModal() {
        $('#crearArticuloModal').modal('show');
    }

    // Función para abrir el modal de selección de imagen
    function openSelectImageModal() {
        $('#selectImageModal').modal('show');
    }

    // Función para subir la imagen seleccionada
    function uploadImage() {
    var formData = new FormData();
    var file = $('#imageFile')[0].files[0];
    formData.append('imageFile', file);

    $.ajax({
        url: '/upload_image', // Aquí se llama a la ruta /upload_image
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
            var imagePath = response.imagePath;
            $('#img_path').val(imagePath); // Actualiza el valor del campo img_path en el formulario
            $('#selectImageModal').modal('hide');
            console.log(imagePath)
        },
        error: function(xhr, status, error) {
            console.error(error);
            // Manejar el error de subida de imagen
        }
    });
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>

</html>